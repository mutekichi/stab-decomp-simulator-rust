name: Release Packages

on:
  push:
    tags:
      - 'v*'      # Tag for necstar: (v0.x.y)
      - 'stab-v*' # Tag for stabilizer-ch-form-rust: (stab-v0.x.y)

permissions:
  contents: read
  id-token: write # needed for PyPI trusted publisher

jobs:
  validate-and-test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Extract Tag and Validate Versions
        run: |
          TAG_NAME=${GITHUB_REF#refs/tags/}
          echo "Processing tag: $TAG_NAME"

          if [[ $TAG_NAME == v* ]]; then
            # Validation for necstar (v0.x.y)
            VERSION=${TAG_NAME#v}
            PYPROJECT_V=$(grep -m 1 '^version = ' pyproject.toml | cut -d '"' -f 2)
            PYTHON_CARGO_V=$(grep -m 1 '^version = ' python/Cargo.toml | cut -d '"' -f 2)
            CORE_CARGO_V=$(grep -m 1 '^version = ' crates/necstar/Cargo.toml | cut -d '"' -f 2)

            echo "Checking necstar version: $VERSION"
            if [ "$VERSION" != "$PYPROJECT_V" ] || [ "$VERSION" != "$PYTHON_CARGO_V" ] || [ "$VERSION" != "$CORE_CARGO_V" ]; then
              echo "Error: Version mismatch for necstar components!"
              echo "Tag: $VERSION, pyproject: $PYPROJECT_V, python/Cargo: $PYTHON_CARGO_V, core/Cargo: $CORE_CARGO_V"
              exit 1
            fi
          elif [[ $TAG_NAME == stab-v* ]]; then
            # Validation for stabilizer-ch-form-rust (stab-v0.x.y)
            VERSION=${TAG_NAME#stab-v}
            STAB_CARGO_V=$(grep -m 1 '^version = ' crates/stabilizer-ch-form-rust/Cargo.toml | cut -d '"' -f 2)

            echo "Checking stabilizer version: $VERSION"
            if [ "$VERSION" != "$STAB_CARGO_V" ]; then
              echo "Error: Version mismatch for stabilizer-ch-form-rust!"
              echo "Tag: $VERSION, Cargo: $STAB_CARGO_V"
              exit 1
            fi
          fi

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Run Rust Tests (Workspace)
        run: cargo test --workspace

      - name: Install poetry
        run: pipx install poetry

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'poetry'

      - name: Configure poetry
        run: poetry config virtualenvs.in-project true

      - name: Install Python dependencies
        run: poetry install --no-interaction

      - name: Run Python Tests
        run: |
          poetry run maturin develop --release --manifest-path python/Cargo.toml
          poetry run pytest

  publish-stabilizer:
    needs: validate-and-test
    if: startsWith(github.ref, 'refs/tags/stab-v')
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - name: Publish stabilizer-ch-form-rust to crates.io
        continue-on-error: true
        run: cargo publish -p stabilizer-ch-form-rust
        env:
          CARGO_REGISTRY_TOKEN: ${{ secrets.CARGO_REGISTRY_TOKEN }}

  publish-necstar-rust:
    needs: validate-and-test
    if: startsWith(github.ref, 'refs/tags/v')
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - name: Publish necstar to crates.io
        continue-on-error: true
        run: cargo publish -p necstar
        env:
          CARGO_REGISTRY_TOKEN: ${{ secrets.CARGO_REGISTRY_TOKEN }}

  build-python-wheels:
    needs: validate-and-test
    if: startsWith(github.ref, 'refs/tags/v')
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            target: x86_64
          - os: ubuntu-latest
            target: aarch64
          - os: windows-latest
            target: x64
          - os: macos-latest
            target: x86_64
          - os: macos-latest
            target: aarch64
    runs-on: ${{ matrix.os }}
    env:
      PYO3_USE_ABI3_FORWARD_COMPATIBILITY: 1
    steps:
      - uses: actions/checkout@v4
      - name: Build wheels
        uses: PyO3/maturin-action@v1
        with:
          target: ${{ matrix.target }}
          args: --release --out dist --manifest-path python/Cargo.toml -i python3.11
          sccache: 'true'
          manylinux: auto
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: wheels-${{ matrix.os }}-${{ matrix.target }}
          path: dist

  publish-python-pypi:
    needs: [build-python-wheels]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/download-artifact@v4
        with:
          pattern: wheels-*
          path: dist
          merge-multiple: true
      - name: Publish to PyPI
        uses: PyO3/maturin-action@v1
        with:
          command: upload
          args: --non-interactive --skip-existing dist/*